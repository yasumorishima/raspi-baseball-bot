# ツイート投稿トラブルシューティング記録

## 問題: Geminiがexecツールを呼ばずツイートが投稿されない

**発覚日**: 2026-02-20

## 経緯

### 第1の問題（2026-02-20 午前に発覚）

Geminiがツイート文を生成するだけで、execツールで`tweet.js`を実行しなかった。
テキストを返すだけではTwitter APIは叩かれないため、投稿されない。

**対策（12:30頃に修正）**: 全7ジョブのsystem-eventプロンプト末尾に以下を追記:

```
ツイート投稿は必ずexecツールで次のコマンドを実行すること:
node /home/yasu/.openclaw/skills/twitter-post/tweet.js "ツイート内容"
— テキストを返すだけでは投稿されない。
```

**結果（修正前後の比較）**:

| 時間 | 修正前/後 | web_search | exec→tweet.js | 結果 |
|------|-----------|------------|---------------|------|
| 08:00 | 修正前 | 1回 | 呼ばず | ツイート文を出力しただけ |
| 10:00 | 修正前 | 2回 | 呼ばず | ツイート文を出力しただけ |
| 12:00 | 修正後 | あり | exitCode:0 | 投稿成功 (ID: 2024680514658201678) |
| 14:00 | 修正後 | あり | exitCode:0 | 投稿成功 (ID: 2024710664766496896) |
| 16:00 | 修正後 | 1回 | 呼ばず | web_searchだけで終了 |

## 失敗ケースの詳細

### 08:00「MLB今日の動き」— 修正前（exec指示なし）

Geminiの動作:
1. `web_search({"query": "MLB news today trade injury"})` — 検索した
2. テキスト出力: ツイート文を生成しただけ。execは呼ばれず投稿されなかった。

**失敗理由**: プロンプトにexec指示がなかった（修正前）。Geminiはツイート文をテキストで返すのが「完了」だと解釈。

### 10:00「WBC最新ニュース」— 修正前（exec指示なし）

Geminiの動作:
1. `web_search({"query": "WBC 2026 news today"})` — 1回目の検索
2. `web_search({"query": "World Baseball Classic 2026 latest"})` — 再検索（指示通り）
3. テキスト出力: ポエムを生成しただけ。execは呼ばれず投稿されなかった。

**失敗理由**: 08:00と同じ。exec指示がなかった。

### 16:00「スプリングトレーニング」— 修正後なのに失敗

Geminiの動作:
1. `web_search({"query": "spring training 2026 results today", "search_lang": "en"})` — 検索した。`search_lang`を指定してしまっている（プロンプトで禁止済みなのに）
2. そのまま終了。ツイート文の生成もexecの呼び出しもなし。

**失敗理由**: exec指示はプロンプト末尾にあったが、Geminiが`web_search` 1回で「完了」と判断。末尾の指示が完全に無視された。`search_lang`禁止の指示も無視しており、プロンプト全体をちゃんと読んでいない可能性が高い。

## 成功ケースの詳細

### 12:00「中南米野球ニュース」— 修正後（exec指示あり）

Geminiの動作:
1. `web_search({"query": "beisbol latinoamerica noticias hoy"})` — スペイン語で検索
2. `web_fetch({"url": "https://www.beisbolencuba.com/"})` — 追加でサイトを見に行った
3. `web_search({"query": "Caribbean baseball news today"})` — 再検索
4. テキスト出力でツイート文を生成
5. `exec({"command": "node .../tweet.js \"カリブの風が運ぶ熱狂...⚾\""})` — **execを実行！ 投稿成功**

**成功理由**: プロンプトにexec指示があり、Geminiが最後まで指示に従った。`web_fetch`（追加の情報収集）まで行っており、このセッションではGeminiが「丁寧モード」だった。

### 14:00「海外の侍ジャパン報道」— 修正後（exec指示あり）

Geminiの動作:
1. `web_search({"query": "Japan baseball players MLB news today"})` — 検索
2. `web_search({"query": "Japanese players spring training 2026"})` — 再検索
3. `exec({"command": "node .../tweet.js \"大谷、山本、佐々木がドジャースのキャンプイン！...⚾\""})` — **execを実行！ 投稿成功**

**成功理由**: 12:00と同じく、exec指示に従った。ツイート文のテキスト出力をスキップして直接execを呼んでおり、効率的。

## なぜ12:00と14:00は成功して16:00は失敗したのか？

同じプロンプト構造（末尾にexec指示）なのに結果が分かれた。

**成功した12:00/14:00の共通点**:
- 複数回のtool callを実行（12:00は4回、14:00は3回）
- Geminiが「まだやることがある」と認識してexecまで進んだ

**失敗した16:00の特徴**:
- `web_search` 1回だけで終了（ツイート文すら出力しなかった）
- `search_lang`指示も無視 → プロンプト全体を雑に処理した可能性
- Geminiの応答品質にはランダム性があり、同じプロンプトでも従ったり従わなかったりする

→ プロンプト末尾にexec指示を置く方式では成功率は上がったが100%ではなかった。

## 第2の問題: 16:00が修正後なのに失敗

修正後のプロンプトでも16:00（スプリングトレーニング）は`web_search`だけで終了。assistantの最終出力にツイート文すら含まれていなかった。

**原因の推定**:
- exec指示がプロンプト末尾にあったため、Geminiが`web_search`結果を処理した時点で「完了」と判断し、後続の指示（exec実行）を読み飛ばした
- Gemini 2.5 Flashは長いプロンプトの末尾の指示を無視する傾向がある

**対策（17:08に修正）**: 全7ジョブのプロンプト構造を「サンドイッチ戦略」に変更:

```
【最重要】このタスクは必ず2ステップで実行せよ。
Step1: web_searchでニュース検索。
Step2: execツールで node /home/yasu/.openclaw/skills/twitter-post/tweet.js "ツイート内容" を実行して投稿。
execを実行しなければタスク失敗。テキストを返すだけでは投稿されない。
---
Step1: web_searchで「...」を検索...ツイート文を作成。
...
Step2: 上で作成したツイート文をexecツールで投稿せよ。
```

**変更のポイント**:
- 冒頭に「exec必須」を配置 → 最初に読まれるので無視されにくい
- Step1/Step2の番号付き構造 → 手順が明確で途中完了しにくい
- 「タスク失敗」という強い文言 → exec省略への抑止力
- 末尾にもStep2で再念押し → 冒頭と末尾の両方で挟み込む（サンドイッチ戦略）

## サンドイッチ戦略の検証結果（2026-02-20）

17:08にプロンプトを「冒頭exec必須指示＋末尾再念押し」のサンドイッチ構造に変更。

### 18:00「韓国台湾野球ニュース」— サンドイッチ戦略後 ✅ 成功

Geminiの動作:
1. `web_search({"query": "KBO NPB CPBL baseball news today"})` — 1回目の検索
2. `web_search({"query": "Asian baseball news today Korea Taiwan"})` — 2回目の検索（指示通り再検索）
3. `exec({"command": "node .../tweet.js \"2026 WBC前哨戦、今日沖縄で韓国代表とサムスン・ライオンズが激突！...⚾\""})` — **execを実行！ 投稿成功 (ID: 2024771051251777824)**

**サンドイッチ戦略の効果**: 冒頭のStep1/Step2指示に従い、web_search→execの2ステップを完遂。`search_lang`パラメータも指定せず、禁止事項も守れている。

## 全体の成績まとめ（2026-02-20）

| 時間 | プロンプト方式 | exec呼び出し | 結果 |
|------|---------------|-------------|------|
| 08:00 | exec指示なし（修正前） | なし | ❌ テキスト出力のみ |
| 10:00 | exec指示なし（修正前） | なし | ❌ テキスト出力のみ |
| 12:00 | 末尾にexec指示（修正1） | あり | ✅ 投稿成功 |
| 14:00 | 末尾にexec指示（修正1） | あり | ✅ 投稿成功 |
| 16:00 | 末尾にexec指示（修正1） | なし | ❌ web_searchだけで終了 |
| 18:00 | サンドイッチ（修正2） | あり | ✅ 投稿成功 |
| 21:00 | サンドイッチ（修正2） | 未実行 | — |

- **修正前**: 0/2（0%）
- **修正1（末尾指示）**: 2/3（67%）
- **修正2（サンドイッチ）**: 1/1（100%） ← サンプル少、2/21以降の結果で要検証

## 教訓

### Gemini 2.5 Flash（無料枠）のクセ

1. **プロンプト末尾の指示を無視しがち** — 重要な指示は冒頭に置くべき
2. **tool callingの実行が不安定** — 同じプロンプトでも呼んだり呼ばなかったりする
3. **1ターンで完了しようとする** — web_search→テキスト出力で終わり、exec呼び出しまで進まないことがある
4. **「必ず実行せよ」「タスク失敗」のような強い表現が有効** — 丁寧な指示より命令調の方が従いやすい

### プロンプト設計の原則

- **最重要指示は冒頭に** （Lost in the Middle問題の回避）
- **番号付きステップで構造化** （途中完了の防止）
- **冒頭と末尾で挟む（サンドイッチ）** （どちらかは読まれる）
- **否定形で補強** （「テキストを返すだけでは投稿されない」）

## 次のアクション

- 2026-02-21の全7ジョブでサンドイッチ戦略の成功率を確認する
- 7本中6本以上成功なら戦略確定、失敗が多ければさらにプロンプト調整

## セッションログの確認方法

```bash
# ツール呼び出しの一覧
grep -oP '"toolName":"[^"]*"' ~/.openclaw/agents/main/sessions/<session-id>.jsonl

# exec実行結果の確認
grep 'exitCode' ~/.openclaw/agents/main/sessions/<session-id>.jsonl

# assistantの最終出力
grep '"role":"assistant"' ~/.openclaw/agents/main/sessions/<session-id>.jsonl | tail -1
```
